<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SiLo</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="editor.css" rel="stylesheet">
    <link href="dark.css" rel="stylesheet">
    <!--<link href="dark.css" rel="stylesheet" media="(prefers-color-scheme: no-preference) or (prefers-color-scheme: dark)">-->
    <!--<link href="light.css" rel="stylesheet" media="prefers-color-scheme: light">-->
    <script>
        function mainplanedozoom(X) {
            zoomg = document.getElementById('mainplanezoom');
            zoomg.setAttribute('transform', "scale(" + (zoomg.getAttribute('transform').toString().match(/\(.*\)/).toString().replace(/[()]/g, "") * X) + ")");
        }
    </script>
</head>
<body>
    <div id="nav">
        <div id="menu">
            <ul id="main-menu">
                <li>
                    <div><span>File</span></div>
                    <ul class="sub-menu">
                        <li><a>submenu</a></li>
                        <li><a>submenu</a></li>
                    </ul>
                </li>
                <li>
                    <div><span>View</span></div>
                    <ul class="sub-menu">
                        <li><a>submenu</a></li>
                        <li><a>submenu</a></li>
                    </ul>
                </li>
                <li>
                    <div><span>MENU3</span></div>
                    <ul class="sub-menu">
                        <li><a>submenu</a></li>
                        <li><a>submenu</a></li>
                        <li><a>submenu</a></li>
                        <li><a>submenu</a></li>
                    </ul>
                </li>
            </ul>
            <div style="clear: both;"></div>
        </div>
    </div>
    <div id="editor" style="height: 100%;">
        <div id="editorview">
            <svg id="mainplane">
                <g id="mainplanemove" transform="translate(0, 0)">
                    <g id="mainplanezoom" transform="scale(1)">
                        <circle cx="50" cy="50" r="50"></circle>
                    </g>
                </g>
            </svg>
            <div id="editornav">
                <button class="editornavzoom" onclick="mainplanedozoom(2);">+</button>
                <button class="editornavzoom" onclick="mainplanedozoom(0.5);">-</button>
                <svg id="editornavmovejoy">
                    <circle cx="4em" cy="4em" r="2.4em" stroke-width="0.2em" stroke="var(--joy-outlinecolor)" fill-opacity="0"></circle>
                    <circle id="editornavmovejoy-stick" r="1.5em" cx="4em" cy="4em" fill="var(--joy-stickcolor)"></circle>
                </svg>
            </div>
        </div>
        <div id="editorlibrary">

        </div>
    </div>

    <script>
        var joy = document.getElementById("editornavmovejoy");
        var stick = joy.getElementById("editornavmovejoy-stick");
        var moveg = document.getElementById('mainplanemove');
        stick.addEventListener("touchstart", down);
        joy.addEventListener("touchmove", move);
        joy.addEventListener("touchend", up);
        stick.addEventListener("mousedown", down);
        joy.addEventListener("mousemove", move);
        joy.addEventListener("mouseup", up);
        //joy.addEventListener("mouseout", up);

        let stickSpeed = 0.05;

        var calcStick = setInterval(function() {
            if(onTouch) {
                var movedstr = moveg.getAttribute('transform').toString().match(/\(.*\)/).toString().replace(/[()]/g, "").split(",");
                var fx = parseFloat(movedstr[0].trim());
                var fy = parseFloat(movedstr[1].trim());
                var dx = Math.cos(joytheta) * joyr * stickSpeed;
                var dy = Math.sin(joytheta) * joyr * stickSpeed;
                //console.log(fx, dx, fy, dy);
                moveg.setAttribute('transform', "translate(" + (fx + dx) + ", " + (fy + dy) + ")");
            }
        }, 50/3);

        var joyr, joytheta;

        var onTouch = false;

        function doStick(event) {
            let position = joy.getBoundingClientRect();
            let x = event.clientX - position.x;
            let y = event.clientY - position.y;
            joyx = x - position.width / 2;
            joyy = y - position.height / 2;

            if(joyx > 0) {
                joytheta = Math.atan(joyy / joyx);
            } else if(joyx < 0) {
                if(joyy >= 0) {
                    joytheta = Math.atan(joyy / joyx) + Math.PI;
                } else {
                    joytheta = Math.atan(joyy / joyx) - Math.PI;
                }
            } else {
                if(joyy > 0) {
                    joytheta = Math.PI / 2;
                } else if(joyy < 0) {
                    joytheta = (-1) * Math.PI / 2;
                } else {
                    joyr = 0;
                }
            }

            joyr = Math.min(Math.sqrt(joyx * joyx + joyy * joyy), Math.sqrt((position.width / 2) * (position.width / 2) + (position.height / 2) * (position.height / 2)) / 8 * 2.5);

            stick.setAttribute("cx", (Math.cos(joytheta) * joyr + position.width / 2) + "px");
            stick.setAttribute("cy", (Math.sin(joytheta) * joyr + position.height / 2) + "px");
            console.log(joytheta, joyr);
        }

        function down(event) {
            onTouch = true;
            stick.setAttribute("fill", "var(--joy-selectcolor)");
            doStick(event);
        }

        function move(event) {
            if(onTouch) {
                doStick(event);
            }
        }

        function up() {
            onTouch = false;
            stick.setAttribute("fill", "var(--joy-stickcolor)");
            stick.setAttribute("cx", "4em");
            stick.setAttribute("cy", "4em");
            joyr = 0;
        }
    </script>
</body>
</html>